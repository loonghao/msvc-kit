name: Bundle Release

# This workflow creates MSVC toolchain bundles and uploads them to GitHub Releases.
# Bundles are only created on release tags to avoid unnecessary downloads.
#
# IMPORTANT: By using these bundles, you agree to Microsoft Visual Studio License Terms:
# https://visualstudio.microsoft.com/license-terms/

on:
  # Trigger on release creation
  release:
    types: [published]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to attach bundles to (e.g., v0.1.3)"
        required: true
        type: string
      msvc_version:
        description: "MSVC version (leave empty for latest)"
        required: false
        type: string
      sdk_version:
        description: "SDK version (leave empty for latest)"
        required: false
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  CARGO_HTTP_TIMEOUT: "600"
  CARGO_NET_RETRY: "10"

jobs:
  # Get version info from manifest
  get-versions:
    name: Get Available Versions
    runs-on: windows-latest
    outputs:
      msvc_version: ${{ steps.versions.outputs.msvc_version }}
      sdk_version: ${{ steps.versions.outputs.sdk_version }}
      tag_name: ${{ steps.tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v6

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build msvc-kit
        run: cargo build --release

      - name: Get versions from manifest
        id: versions
        shell: pwsh
        run: |
          # Get available versions
          $output = & ".\target\release\msvc-kit.exe" list --available 2>&1
          Write-Host "Available versions output:"
          Write-Host $output
          
          # Parse MSVC version
          $msvcVersion = if ("${{ inputs.msvc_version }}" -ne "") {
            "${{ inputs.msvc_version }}"
          } else {
            ($output | Select-String "Latest MSVC version: (.+)").Matches.Groups[1].Value
          }
          
          # Parse SDK version
          $sdkVersion = if ("${{ inputs.sdk_version }}" -ne "") {
            "${{ inputs.sdk_version }}"
          } else {
            ($output | Select-String "Latest Windows SDK version: (.+)").Matches.Groups[1].Value
          }
          
          Write-Host "Selected MSVC version: $msvcVersion"
          Write-Host "Selected SDK version: $sdkVersion"
          
          echo "msvc_version=$msvcVersion" >> $env:GITHUB_OUTPUT
          echo "sdk_version=$sdkVersion" >> $env:GITHUB_OUTPUT

  # Build bundles for each architecture combination
  build-bundle:
    name: Bundle (${{ matrix.host_arch }}-${{ matrix.target_arch }})
    runs-on: windows-latest
    needs: get-versions
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native builds
          - host_arch: x64
            target_arch: x64
          - host_arch: x86
            target_arch: x86
          # Cross-compilation from x64
          - host_arch: x64
            target_arch: x86
          - host_arch: x64
            target_arch: arm64
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: bundle-${{ matrix.host_arch }}-${{ matrix.target_arch }}

      - name: Build msvc-kit
        run: cargo build --release

      - name: Create bundle
        id: bundle
        shell: pwsh
        env:
          MSVC_VERSION: ${{ needs.get-versions.outputs.msvc_version }}
          SDK_VERSION: ${{ needs.get-versions.outputs.sdk_version }}
        run: |
          $bundleDir = Join-Path $env:GITHUB_WORKSPACE "msvc-bundle"
          $msvcVersion = $env:MSVC_VERSION
          $sdkVersion = $env:SDK_VERSION
          
          Write-Host "Creating bundle with:"
          Write-Host "  MSVC: $msvcVersion"
          Write-Host "  SDK: $sdkVersion"
          Write-Host "  Host: ${{ matrix.host_arch }}"
          Write-Host "  Target: ${{ matrix.target_arch }}"
          
          & ".\target\release\msvc-kit.exe" bundle `
            --accept-license `
            --msvc-version $msvcVersion `
            --sdk-version $sdkVersion `
            --host-arch ${{ matrix.host_arch }} `
            --arch ${{ matrix.target_arch }} `
            --output $bundleDir
          
          if ($LASTEXITCODE -ne 0) {
            throw "Bundle creation failed"
          }
          
          # Get actual installed versions from bundle
          $vcToolsDir = Get-ChildItem -Path "$bundleDir\VC\Tools\MSVC" -Directory | Select-Object -First 1
          $actualMsvcVersion = $vcToolsDir.Name
          
          $sdkIncludeDir = Get-ChildItem -Path "$bundleDir\Windows Kits\10\Include" -Directory | 
            Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | 
            Sort-Object Name -Descending | 
            Select-Object -First 1
          $actualSdkVersion = $sdkIncludeDir.Name
          
          Write-Host "Actual versions in bundle:"
          Write-Host "  MSVC: $actualMsvcVersion"
          Write-Host "  SDK: $actualSdkVersion"
          
          echo "actual_msvc_version=$actualMsvcVersion" >> $env:GITHUB_OUTPUT
          echo "actual_sdk_version=$actualSdkVersion" >> $env:GITHUB_OUTPUT

      - name: Verify bundle
        shell: cmd
        run: |
          cd msvc-bundle
          call setup.bat
          where cl
          cl /?
          echo ✅ Bundle verification passed

      - name: Create zip archive
        id: zip
        shell: pwsh
        run: |
          $msvcVersion = "${{ steps.bundle.outputs.actual_msvc_version }}"
          $sdkVersion = "${{ steps.bundle.outputs.actual_sdk_version }}"
          $hostArch = "${{ matrix.host_arch }}"
          $targetArch = "${{ matrix.target_arch }}"
          
          # Format: msvc-bundle-<msvc>-<sdk>-<host>-<target>.zip
          $zipName = "msvc-bundle-${msvcVersion}-${sdkVersion}-${hostArch}-${targetArch}.zip"
          
          Write-Host "Creating archive: $zipName"
          
          Compress-Archive -Path "msvc-bundle\*" -DestinationPath $zipName -Force
          
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "Archive size: $([math]::Round($size, 2)) MB"
          
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
          echo "zip_path=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.zip.outputs.zip_name }}
          path: ${{ steps.zip.outputs.zip_path }}
          retention-days: 7

  # Upload all bundles to the release
  upload-to-release:
    name: Upload to Release
    runs-on: ubuntu-latest
    needs: [get-versions, build-bundle]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: bundles
          pattern: msvc-bundle-*
          merge-multiple: true

      - name: List bundles
        run: |
          echo "Bundle files to upload:"
          ls -lah bundles/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-versions.outputs.tag_name }}
          files: bundles/*.zip
          fail_on_unmatched_files: false
          body: |
            
            ---
            
            ### MSVC Toolchain Bundles
            
            Pre-built MSVC toolchain bundles are available for download. These bundles contain:
            - MSVC Compiler (cl.exe, link.exe, etc.)
            - Windows SDK (headers, libraries, tools)
            - Activation scripts (setup.bat, setup.ps1, setup.sh)
            
            **Bundle naming:** `msvc-bundle-<msvc-version>-<sdk-version>-<host-arch>-<target-arch>.zip`
            
            | Host | Target | Use Case |
            |------|--------|----------|
            | x64 | x64 | Native 64-bit development |
            | x64 | x86 | Cross-compile 32-bit from 64-bit host |
            | x64 | arm64 | Cross-compile ARM64 from 64-bit host |
            | x86 | x86 | Native 32-bit development |
            
            **Usage:**
            ```bash
            # Extract and activate
            unzip msvc-bundle-*.zip -d msvc-bundle
            cd msvc-bundle
            
            # CMD
            setup.bat
            
            # PowerShell
            .\setup.ps1
            
            # Bash/WSL
            source setup.sh
            
            # Now compile
            cl /nologo test.c
            ```
            
            > ⚠️ **License Notice:** By downloading these bundles, you agree to the [Microsoft Visual Studio License Terms](https://visualstudio.microsoft.com/license-terms/).
          append_body: true
